<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pictionay game</title>
  <style>
    .board {
      position: relative;
      border-style: solid;
      border-color: black;
      width: 800px;
      height: 500px;
      margin: 0 auto;
    }
    .canvas{
      position: fixed;
    }
  </style>
</head>

<body>
  <button id="clear-btn">Clear</button>
  <button id="save-btn">Save</button>
  <button id="download-btn">Download</button>
  <div class="board" id="drawing-board">
    <canvas class="canvas" id="canvas" width="800" height="500"></canvas>
  </div>
  <script>
    var ctxPositions = [];
    var positions = [];
    //var canvas = document.createElement('canvas');
    var drawingBoard = document.getElementById('drawing-board');
    var boardWidth = drawingBoard.clientWidth;
    var boardHeight = drawingBoard.clientTop;
    // get canvas 2D context and set him correct size
    var ctx = canvas.getContext('2d');
    resize();
    // first known position
    var startPos = {x: 0, y: 0};
    // last known position
    var pos = { x: 0, y: 0 };

    window.addEventListener('resize', resize);
    document.addEventListener('mousemove', draw);
    document.addEventListener('mousedown', mouseDown);
    document.addEventListener('mouseenter', setPosition);
    document.addEventListener('mouseup', onMouseOut)
    document.addEventListener('mouseover', onMousOver);

    function onMousOver(e){
      if(e.target != canvas) return;
    }
    
    function mouseDown(e){
      if(e.target != canvas) return;

      startPos.x = e.clientX - drawingBoard.offsetLeft;
      startPos.y = e.clientY - drawingBoard.offsetTop;
      setPosition(e)
    }

    // new position from mouse event
    function setPosition(e) {
      if (e.target !== canvas) {
        return;
      }
      pos.x = e.clientX - drawingBoard.offsetLeft;
      pos.y = e.clientY - drawingBoard.offsetTop;
    }

    function onMouseOut(e) {
      if(e.target !== canvas) return;
      const cv = {
        id: ctxPositions.length,
        positions: [...positions]
      };
      ctxPositions.push({...cv});
      positions = [];
    }

    // resize canvas
    function resize() {
      ctx.canvas.width = window.innerWidth;
      ctx.canvas.height = window.innerHeight;
    }

    function draw(e) {
      // mouse left button must be pressed
      if (e.buttons !== 1) return;

      ctx.beginPath(); // begin

      ctx.lineWidth = 5;
      ctx.lineCap = 'round';
      ctx.strokeStyle = 'black';

      ctx.moveTo(pos.x, pos.y); // from
      setPosition(e);
      ctx.lineTo(pos.x, pos.y); // to
      ctx.stroke(); // draw it!
      var newPos = {...pos};
      if(newPos !== pos){
        positions.push({ ...pos });
      }
    }

    function createCanvas(){
      var canvas = document.createElement('canvas');
      drawingBoard.appendChild(canvas)
      var ctx = canvas.getContext('2d');
    }

    var downloadbtn = document.getElementById('download-btn');
      downloadbtn.addEventListener('click', () => {
      const a = document.createElement("a");
      a.href = URL.createObjectURL(new Blob([JSON.stringify(ctxPositions, null, 2)], {
        type: "text/plain"
      }));
      a.setAttribute("download", "data.txt");
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    });

    var btnEle = document.getElementById('clear-btn');
    btnEle.addEventListener('click', () => {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      // ctx.clearRect(120, 0, 30, 30);
      // ctx.clearRect(120, 30, 30, 30);
      // ctx.clearRect(150, 0, 30, 30);
      // ctx.clearRect(150, 30, 30, 30);
    });

    var saveBtnEle = document.getElementById('save-btn');
    saveBtnEle.addEventListener('click', () => {
      // var canvas = document.createElement('canvas');
      // drawingBoard.appendChild(canvas)
      // var _ctx = canvas.getContext('2d');

      // var $context = canvas.getContext('2d');
      // $context.beginPath()
      // Create 4 filled squares
      // ctx.fillStyle = 'pink';
      // ctx.fillRect(120, 0, 30, 30);
      // ctx.fillRect(120, 30, 30, 30);
      // ctx.fillRect(150, 0, 30, 30);
      // ctx.fillRect(150, 30, 30, 30);

      // // Create borders around them
      // ctx.strokeRect(120, 0, 30, 30);
      // ctx.strokeRect(120, 30, 30, 30);
      // ctx.strokeRect(150, 0, 30, 30);
      // ctx.strokeRect(150, 30, 30, 30);

      // Now erase the squares (individually)
      // $context.clearRect(120, 0, 30, 30);
      // $context.clearRect(120, 30, 30, 30);
      // $context.clearRect(150, 0, 30, 30);
      // $context.clearRect(150, 30, 30, 30);

      
      // var item = ctxPositions[0];
      ctxPositions.forEach((item) => {
        ctx.beginPath(); // begin
        ctx.lineWidth = 5;
        ctx.lineCap = 'round';
        ctx.strokeStyle = 'black';
        ctx.moveTo(item.positions[0].x, item.positions[0].y);
        item.positions.forEach((pos, index) => {
          if(index != 0){
            ctx.lineTo(pos.x, pos.y);
          }
        })
        ctx.stroke();
      }) 
    });
  </script>
</body>

</html>